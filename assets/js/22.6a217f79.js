(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{370:function(s,t,a){s.exports=a.p+"assets/img/lru.81452dd2.png"},371:function(s,t,a){s.exports=a.p+"assets/img/lru-cache.21d912ff.png"},481:function(s,t,a){"use strict";a.r(t);var n=a(11),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"面试题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#面试题"}},[s._v("#")]),s._v(" 面试题")]),s._v(" "),t("p",[s._v("Redis 的过期策略都有哪些？内存淘汰机制都有哪些？手写一下 LRU 代码实现？")]),s._v(" "),t("h2",{attrs:{id:"面试官心理分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#面试官心理分析"}},[s._v("#")]),s._v(" 面试官心理分析")]),s._v(" "),t("p",[s._v("如果你连这个问题都不知道，上来就懵了，回答不出来，那线上你写代码的时候，想当然的认为写进 Redis 的数据就一定会存在，后面导致系统各种 bug，谁来负责？")]),s._v(" "),t("p",[s._v("常见的有两个问题：")]),s._v(" "),t("ul",[t("li",[s._v("往 Redis 写入的数据怎么没了？")])]),s._v(" "),t("p",[s._v("可能有同学会遇到，在生产环境的 Redis 经常会丢掉一些数据，写进去了，过一会儿可能就没了。我的天，同学，你问这个问题就说明 Redis 你就没用对啊。Redis 是缓存，你给当存储了是吧？")]),s._v(" "),t("p",[s._v("啥叫缓存？用内存当缓存。内存是无限的吗，内存是很宝贵而且是有限的，磁盘是廉价而且是大量的。可能一台机器就几十个 G 的内存，但是可以有几个 T 的硬盘空间。Redis 主要是基于内存来进行高性能、高并发的读写操作的。")]),s._v(" "),t("p",[s._v("那既然内存是有限的，比如 Redis 就只能用 10G，你要是往里面写了 20G 的数据，会咋办？当然会干掉 10G 的数据，然后就保留 10G 的数据了。那干掉哪些数据？保留哪些数据？当然是干掉不常用的数据，保留常用的数据了。")]),s._v(" "),t("ul",[t("li",[s._v("数据明明过期了，怎么还占用着内存？")])]),s._v(" "),t("p",[s._v("这是由 Redis 的过期策略来决定。")]),s._v(" "),t("h2",{attrs:{id:"面试题剖析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#面试题剖析"}},[s._v("#")]),s._v(" 面试题剖析")]),s._v(" "),t("h3",{attrs:{id:"redis-过期策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-过期策略"}},[s._v("#")]),s._v(" Redis 过期策略")]),s._v(" "),t("p",[s._v("Redis 过期策略是："),t("strong",[s._v("定期删除+惰性删除")]),s._v("。")]),s._v(" "),t("p",[s._v("所谓"),t("strong",[s._v("定期删除")]),s._v("，指的是 Redis 默认是每隔 100ms 就随机抽取一些设置了过期时间的 key，检查其是否过期，如果过期就删除。")]),s._v(" "),t("p",[s._v("假设 Redis 里放了 10w 个 key，都设置了过期时间，你每隔几百毫秒，就检查 10w 个 key，那 Redis 基本上就死了，cpu 负载会很高的，消耗在你的检查过期 key 上了。注意，这里可不是每隔 100ms 就遍历所有的设置过期时间的 key，那样就是一场性能上的"),t("strong",[s._v("灾难")]),s._v("。实际上 Redis 是每隔 100ms "),t("strong",[s._v("随机抽取")]),s._v("一些 key 来检查和删除的。")]),s._v(" "),t("p",[s._v("但是问题是，定期删除可能会导致很多过期 key 到了时间并没有被删除掉，那咋整呢？所以就是惰性删除了。这就是说，在你获取某个 key 的时候，Redis 会检查一下 ，这个 key 如果设置了过期时间那么是否过期了？如果过期了此时就会删除，不会给你返回任何东西。")]),s._v(" "),t("blockquote",[t("p",[s._v("获取 key 的时候，如果此时 key 已经过期，就删除，不会返回任何东西。")])]),s._v(" "),t("p",[s._v("但是实际上这还是有问题的，如果定期删除漏掉了很多过期 key，然后你也没及时去查，也就没走惰性删除，此时会怎么样？如果大量过期 key 堆积在内存里，导致 Redis 内存块耗尽了，咋整？")]),s._v(" "),t("p",[s._v("答案是："),t("strong",[s._v("走内存淘汰机制")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"内存淘汰机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内存淘汰机制"}},[s._v("#")]),s._v(" 内存淘汰机制")]),s._v(" "),t("p",[s._v("Redis 内存淘汰机制有以下几个：")]),s._v(" "),t("ul",[t("li",[s._v("noeviction: 当内存不足以容纳新写入数据时，新写入操作会报错，这个一般没人用吧，实在是太恶心了。")]),s._v(" "),t("li",[t("strong",[s._v("allkeys-lru")]),s._v("：当内存不足以容纳新写入数据时，在"),t("strong",[s._v("键空间")]),s._v("中，移除最近最少使用的 key（这个是"),t("strong",[s._v("最常用")]),s._v("的）。")]),s._v(" "),t("li",[s._v("allkeys-random：当内存不足以容纳新写入数据时，在"),t("strong",[s._v("键空间")]),s._v("中，随机移除某个 key，这个一般没人用吧，为啥要随机，肯定是把最近最少使用的 key 给干掉啊。")]),s._v(" "),t("li",[s._v("volatile-lru：当内存不足以容纳新写入数据时，在"),t("strong",[s._v("设置了过期时间的键空间")]),s._v("中，移除最近最少使用的 key（这个一般不太合适）。")]),s._v(" "),t("li",[s._v("volatile-random：当内存不足以容纳新写入数据时，在"),t("strong",[s._v("设置了过期时间的键空间")]),s._v("中，"),t("strong",[s._v("随机移除")]),s._v("某个 key。")]),s._v(" "),t("li",[s._v("volatile-ttl：当内存不足以容纳新写入数据时，在"),t("strong",[s._v("设置了过期时间的键空间")]),s._v("中，有"),t("strong",[s._v("更早过期时间")]),s._v("的 key 优先移除。")])]),s._v(" "),t("h3",{attrs:{id:"手写一个-lru-算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#手写一个-lru-算法"}},[s._v("#")]),s._v(" 手写一个 LRU 算法")]),s._v(" "),t("p",[s._v("LRU 就是 Least Recently Used 的缩写，翻译过来就是“最近最少使用”。也就是说 LRU 算法会将最近最少用的缓存移除，让给最新使用的缓存。而往往最常读取的，也就是读取次数最多的，所以利用好 LRU 算法，我们能够提供对热点数据的缓存效率，能够提高缓存服务的内存使用率。")]),s._v(" "),t("p",[s._v("那么如何实现呢？")]),s._v(" "),t("p",[s._v("其实，实现的思路非常简单，就像下面这张图种描述的一样。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(370),alt:""}})]),s._v(" "),t("p",[s._v("你可以现场手写最原始的 LRU 算法，那个代码量太大了，似乎不太现实。")]),s._v(" "),t("p",[s._v("不求自己纯手工从底层开始打造出自己的 LRU，但是起码要知道如何利用已有的 JDK 数据结构实现一个 Java 版的 LRU。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(371),alt:""}})]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LRUCache")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LinkedHashMap")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" capacity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 传递进来最多能缓存多少数据\n     *\n     * @param capacity 缓存大小\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LRUCache")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" capacity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("super")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("capacity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.75f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("capacity "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" capacity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 如果map中的数据量大于设定的最大容量，返回true，再新加入对象时删除最老的数据\n     *\n     * @param eldest 最老的数据项\n     * @return true则移除最老的数据\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("protected")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("removeEldestEntry")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Entry")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" eldest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当 map中的数据量大于指定的缓存个数的时候，自动移除最老的数据")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("size")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" capacity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);