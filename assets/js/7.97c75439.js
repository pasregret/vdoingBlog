(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{345:function(A,r,t){A.exports=t.p+"assets/img/mq-7.75d36ed1.png"},346:function(A,r,t){A.exports=t.p+"assets/img/mq-8.20a6c4d8.png"},347:function(A,r){A.exports="data:image/png;base64,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"},348:function(A,r,t){A.exports=t.p+"assets/img/kafka-after.e601405b.png"},465:function(A,r,t){"use strict";t.r(r);var e=t(11),a=Object(e.a)({},(function(){var A=this,r=A._self._c;return r("ContentSlotsDistributor",{attrs:{"slot-key":A.$parent.slotKey}},[r("h2",{attrs:{id:"面试题"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#面试题"}},[A._v("#")]),A._v(" 面试题")]),A._v(" "),r("p",[A._v("如何保证消息队列的高可用？")]),A._v(" "),r("h2",{attrs:{id:"面试官心理分析"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#面试官心理分析"}},[A._v("#")]),A._v(" 面试官心理分析")]),A._v(" "),r("p",[A._v("如果有人问到你 MQ 的知识，"),r("strong",[A._v("高可用是必问的")]),A._v("。"),r("RouterLink",{attrs:{to:"/docs/high-concurrency/why-mq.html"}},[A._v("上一讲")]),A._v("提到，MQ 会导致"),r("strong",[A._v("系统可用性降低")]),A._v("。所以只要你用了 MQ，接下来问的一些要点肯定就是围绕着 MQ 的那些缺点怎么来解决了。")],1),A._v(" "),r("p",[A._v("要是你傻乎乎的就干用了一个 MQ，各种问题从来没考虑过，那你就杯具了，面试官对你的感觉就是，只会简单使用一些技术，没任何思考，马上对你的印象就不太好了。这样的同学招进来要是做个 20k 薪资以内的普通小弟还凑合，要是做薪资 20k+ 的高工，那就惨了，让你设计个系统，里面肯定一堆坑，出了事故公司受损失，团队一起背锅。")]),A._v(" "),r("h2",{attrs:{id:"面试题剖析"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#面试题剖析"}},[A._v("#")]),A._v(" 面试题剖析")]),A._v(" "),r("p",[A._v("这个问题这么问是很好的，因为不能问你 Kafka 的高可用性怎么保证？ActiveMQ 的高可用性怎么保证？一个面试官要是这么问就显得很没水平，人家可能用的就是 RabbitMQ，没用过 Kafka，你上来问人家 Kafka 干什么？这不是摆明了刁难人么。")]),A._v(" "),r("p",[A._v("所以有水平的面试官，问的是 MQ 的高可用性怎么保证？这样就是你用过哪个 MQ，你就说说你对那个 MQ 的高可用性的理解。")]),A._v(" "),r("h3",{attrs:{id:"rabbitmq-的高可用性"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq-的高可用性"}},[A._v("#")]),A._v(" RabbitMQ 的高可用性")]),A._v(" "),r("p",[A._v("RabbitMQ 是比较有代表性的，因为是"),r("strong",[A._v("基于主从")]),A._v("（非分布式）做高可用性的，我们就以 RabbitMQ 为例子讲解第一种 MQ 的高可用性怎么实现。")]),A._v(" "),r("p",[A._v("RabbitMQ 有三种模式：单机模式、普通集群模式、镜像集群模式。")]),A._v(" "),r("h4",{attrs:{id:"单机模式"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#单机模式"}},[A._v("#")]),A._v(" 单机模式")]),A._v(" "),r("p",[A._v("单机模式，就是 Demo 级别的，一般就是你本地启动了玩玩儿的，没人生产用单机模式。")]),A._v(" "),r("h4",{attrs:{id:"普通集群模式（无高可用性）"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#普通集群模式（无高可用性）"}},[A._v("#")]),A._v(" 普通集群模式（无高可用性）")]),A._v(" "),r("p",[A._v("普通集群模式，意思就是在多台机器上启动多个 RabbitMQ 实例，每台机器启动一个。你"),r("strong",[A._v("创建的 queue，只会放在一个 RabbitMQ 实例上")]),A._v("，但是每个实例都同步 queue 的元数据（元数据可以认为是 queue 的一些配置信息，通过元数据，可以找到 queue 所在实例）。你消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从 queue 所在实例上拉取数据过来。")]),A._v(" "),r("p",[r("img",{attrs:{src:t(345),alt:"mq-7"}})]),A._v(" "),r("p",[A._v("这种方式确实很麻烦，也不怎么好，"),r("strong",[A._v("没做到所谓的分布式")]),A._v("，就是个普通集群。因为这导致你要么消费者每次随机连接一个实例然后拉取数据，要么固定连接那个 queue 所在实例消费数据，前者有"),r("strong",[A._v("数据拉取的开销")]),A._v("，后者导致"),r("strong",[A._v("单实例性能瓶颈")]),A._v("。")]),A._v(" "),r("p",[A._v("而且如果那个放 queue 的实例宕机了，会导致接下来其他实例就无法从那个实例拉取，如果你"),r("strong",[A._v("开启了消息持久化")]),A._v("，让 RabbitMQ 落地存储消息的话，"),r("strong",[A._v("消息不一定会丢")]),A._v("，得等这个实例恢复了，然后才可以继续从这个 queue 拉取数据。")]),A._v(" "),r("p",[A._v("所以这个事儿就比较尴尬了，这就"),r("strong",[A._v("没有什么所谓的高可用性")]),A._v("，"),r("strong",[A._v("这方案主要是提高吞吐量的")]),A._v("，就是说让集群中多个节点来服务某个 queue 的读写操作。")]),A._v(" "),r("h4",{attrs:{id:"镜像集群模式（高可用性）"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#镜像集群模式（高可用性）"}},[A._v("#")]),A._v(" 镜像集群模式（高可用性）")]),A._v(" "),r("p",[A._v("这种模式，才是所谓的 RabbitMQ 的高可用模式。跟普通集群模式不一样的是，在镜像集群模式下，你创建的 queue，无论是元数据还是 queue 里的消息都会"),r("strong",[A._v("存在于多个实例上")]),A._v("，就是说，每个 RabbitMQ 节点都有这个 queue 的一个"),r("strong",[A._v("完整镜像")]),A._v("，包含 queue 的全部数据的意思。然后每次你写消息到 queue 的时候，都会自动把"),r("strong",[A._v("消息同步")]),A._v("到多个实例的 queue 上。")]),A._v(" "),r("p",[r("img",{attrs:{src:t(346),alt:"mq-8"}})]),A._v(" "),r("p",[A._v("那么"),r("strong",[A._v("如何开启这个镜像集群模式")]),A._v("呢？其实很简单，RabbitMQ 有很好的管理控制台，就是在后台新增一个策略，这个策略是"),r("strong",[A._v("镜像集群模式的策略")]),A._v("，指定的时候是可以要求数据同步到所有节点的，也可以要求同步到指定数量的节点，再次创建 queue 的时候，应用这个策略，就会自动将数据同步到其他的节点上去了。")]),A._v(" "),r("p",[A._v("这样的话，好处在于，你任何一个机器宕机了，没事儿，其它机器（节点）还包含了这个 queue 的完整数据，别的 consumer 都可以到其它节点上去消费数据。坏处在于，第一，这个性能开销也太大了吧，消息需要同步到所有机器上，导致网络带宽压力和消耗很重！第二，这么玩儿，不是分布式的，就"),r("strong",[A._v("没有扩展性可言")]),A._v("了，如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并"),r("strong",[A._v("没有办法线性扩展")]),A._v("你的 queue。你想，如果这个 queue 的数据量很大，大到这个机器上的容量无法容纳了，此时该怎么办呢？")]),A._v(" "),r("h3",{attrs:{id:"kafka-的高可用性"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#kafka-的高可用性"}},[A._v("#")]),A._v(" Kafka 的高可用性")]),A._v(" "),r("p",[A._v("Kafka 一个最基本的架构认识：由多个 broker 组成，每个 broker 是一个节点；你创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。")]),A._v(" "),r("p",[A._v("这就是"),r("strong",[A._v("天然的分布式消息队列")]),A._v("，就是说一个 topic 的数据，是"),r("strong",[A._v("分散放在多个机器上的，每个机器就放一部分数据")]),A._v("。")]),A._v(" "),r("p",[A._v("实际上 RabbitMQ 之类的，并不是分布式消息队列，它就是传统的消息队列，只不过提供了一些集群、HA(High Availability, 高可用性) 的机制而已，因为无论怎么玩儿，RabbitMQ 一个 queue 的数据都是放在一个节点里的，镜像集群模式下，也是每个节点都放这个 queue 的完整数据。")]),A._v(" "),r("p",[A._v("Kafka 0.8 以前，是没有 HA 机制的，就是任何一个 broker 宕机了，那个 broker 上的 partition 就废了，没法写也没法读，没有什么高可用性可言。")]),A._v(" "),r("p",[A._v("比如说，我们假设创建了一个 topic，指定其 partition 数量是 3 个，分别在三台机器上。但是，如果第二台机器宕机了，会导致这个 topic 的 1/3 的数据就丢了，因此这个是做不到高可用的。")]),A._v(" "),r("p",[r("img",{attrs:{src:t(347),alt:"kafka-before"}})]),A._v(" "),r("p",[A._v("Kafka 0.8 以后，提供了 HA 机制，就是 replica（复制品） 副本机制。每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有 replica 会选举一个 leader 出来，那么生产和消费都跟这个 leader 打交道，然后其他 replica 就是 follower。写的时候，leader 会负责把数据同步到所有 follower 上去，读的时候就直接读 leader 上的数据即可。只能读写 leader？很简单，"),r("strong",[A._v("要是你可以随意读写每个 follower，那么就要 care 数据一致性的问题")]),A._v("，系统复杂度太高，很容易出问题。Kafka 会均匀地将一个 partition 的所有 replica 分布在不同的机器上，这样才可以提高容错性。")]),A._v(" "),r("p",[r("img",{attrs:{src:t(348),alt:"kafka-after"}})]),A._v(" "),r("p",[A._v("这么搞，就有所谓的"),r("strong",[A._v("高可用性")]),A._v("了，因为如果某个 broker 宕机了，没事儿，那个 broker 上面的 partition 在其他机器上都有副本的。如果这个宕机的 broker 上面有某个 partition 的 leader，那么此时会从 follower 中"),r("strong",[A._v("重新选举")]),A._v("一个新的 leader 出来，大家继续读写那个新的 leader 即可。这就有所谓的高可用性了。")]),A._v(" "),r("p",[r("strong",[A._v("写数据")]),A._v("的时候，生产者就写 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。（当然，这只是其中一种模式，还可以适当调整这个行为）")]),A._v(" "),r("p",[r("strong",[A._v("消费")]),A._v("的时候，只会从 leader 去读，但是只有当一个消息已经被所有 follower 都同步成功返回 ack 的时候，这个消息才会被消费者读到。")]),A._v(" "),r("p",[A._v("看到这里，相信你大致明白了 Kafka 是如何保证高可用机制的了，对吧？不至于一无所知，现场还能给面试官画画图。要是遇上面试官确实是 Kafka 高手，深挖了问，那你只能说不好意思，太深入的你没研究过。")])])}),[],!1,null,null,null);r.default=a.exports}}]);